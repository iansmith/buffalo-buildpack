#!/bin/bash
set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

GO_VERSION=1.11.4

echo "++++++> $BUILD_DIR"
echo "++++++> $CACHE_DIR"
echo "++++++> $ENV_DIR"

echo --------
ls -l $CACHE_DIR
echo --------
if [ -d $CACHE_DIR/go ]; then
  echo found go cache
  ls -l $CACHE_DIR/go
fi

echo our directory is $CACHE_DIR/go${GO_VERSION}/bin

if [ -f $CACHE_DIR/go${GO_VERSION}/bin ]; then
  echo "++++++> found cached $CACHE_DIR/go${GO_VERSION}/bin"
  ls -l $CACHE_DIR/go${GO_VERSION}/bin
else
  echo "------> downloading go1.11.4"
  pushd $CACHE_DIR >& /dev/null
  wget -q https://dl.google.com/go/go1.11.4.linux-amd64.tar.gz
  tar zxf go1.11.4.linux-amd64.tar.gz
  mv go go1.11.4
  rm -f *.tar *.gz
  popd >& /dev/null
fi

export PATH=$PATH:$CACHE_DIR/go${GO_VERSION}/bin
echo path is $PATH
echo -------
ls -l $CACHE_DIR/go${GO_VERSION}/bin
echo -----
go env
echo -----
export GOBIN=$CACHE_DIR/go${GO_VERSION}/bin

echo "------> downloading buffalo"
go get -u github.com/gobuffalo/buffalo/...
echo "------> installed " `buffalo version`

echo "++++++> $CACHE_DIR/go${GO_VERSION}/bin"
ls $CACHE_DIR/go${GO_VERSION}/bin

echo "++++++> ls $BUILD_DIR"
ls $BUILD_DIR
echo "++++++> ls $CACHE_DIR"
ls $CACHE_DIR
echo "++++++> ls $ENV_DIR"
ls $ENV_DIR

cd $BUILD_DIR
environment=development

if [ -f "$ENV_DIR/GO_ENV" ]; then
  environment=`cat $ENV_DIR/GO_ENV`
fi

buffalo build --environment=$environment --static -o /bin/app
