#!/bin/bash
set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

GO_VERSION=1.11.4
NODE_VERSION=11.4.0

if [ -f $CACHE_DIR/go${GO_VERSION}/bin ]; then
  echo "++++++> found cached $CACHE_DIR/go${GO_VERSION}/bin"
  ls -l $CACHE_DIR/go${GO_VERSION}/bin
else
  echo "-----> downloading go ${GO_VERSION}"
  pushd $CACHE_DIR >& /dev/null
  wget -q https://dl.google.com/go/go1.11.4.linux-amd64.tar.gz
  tar zxf go1.11.4.linux-amd64.tar.gz
  mv go go1.11.4
  rm -f *.tar *.gz
  popd >& /dev/null
fi

if [ -f $CACHE_DIR/node${NODE_VERSION}/bin ]; then
  echo "-----> found cached $CACHE_DIR/node${NODE_VERSION}/bin"
  ls -l $CACHE_DIR/node${NODE_VERSION}/bin
else
  echo "-----> downloading node ${NODE_VERSION}"
  pushd $CACHE_DIR >& /dev/null
  wget -q https://nodejs.org/dist/v11.4.0/node-v11.4.0-linux-x64.tar.xz
  tar xf node-v11.4.0-linux-x64.tar.xz
  rm -f *.tar *.xz
  mv node* node${NODE_VERSION}
  popd >& /dev/null
fi

export PATH=$PATH:$CACHE_DIR/go${GO_VERSION}/bin
export PATH=$PATH:$CACHE_DIR/node${NODE_VERSION}/bin
export GOBIN=$CACHE_DIR/go${GO_VERSION}/bin

echo "-----> downloading buffalo"
go get -u github.com/gobuffalo/buffalo/...
echo "-----> buffalo version... "
buffalo version

cd $BUILD_DIR
echo "-----> installing webpack 4.5.0"
npm install --loglevel=error webpack@4.5.0
echo "-----> installing webpack-cli 3.1.0"
npm install --loglevel=error webpack-cli@3.1.0
echo "-----> installing glob 7.1.3"
npm install --loglevel=error glob@7.1.3
echo "-----> installing copy-webpack-plugin 4.5.4"
npm install --loglevel=error copy-webpack-plugin@4.5.4
echo "-----> installing mini-css-extract-plugin 0.4.5"
npm install --loglevel=error mini-css-extract-plugin@0.4.5
echo "-----> installing webpack-manifest-plugin 2.0.4"
npm install --loglevel=error webpack-manifest-plugin@2.0.4
echo "-----> webpack-clean-obsolete-chunks 0.4.0"
npm install --loglevel=error webpack-clean-obsolete-chunks@0.4.0
echo "-----> webpack-livereload-plugin 2.1.1"
npm install --loglevel=error webpack-livereload-plugin@2.1.1
echo "-----> jquery 3.2.1"
npm install --loglevel=error jquery@3.2.1

environment=development

if [ -f "$ENV_DIR/GO_ENV" ]; then
  environment=`cat $ENV_DIR/GO_ENV`
fi

echo "-----> building for environment $environment"
buffalo build --environment=$environment -d --static -o /bin/app
